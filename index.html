<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width,
 initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
	<title>Document</title>
	<link rel="stylesheet" href="css/style.css">

</head>

<body>
	<div id="content">
		<div id="info">
			<div id="score"><span>得分:</span>0</div>
			<form action="" name="form" id="form ">
				<input type="button" value="开始" class="button" id="start">
				<input type="button" value="重玩" class="button" id="res">
			</form>
		</div>
		<div id="main">

			<div id="home">
				<div id="snakeOver"></div>
			</div> 
		</div>
		<div class="keycode">
			<div class="left-top">
				
				<div id="top" class="top keyCo1 keyTap">▲</div>
			</div>
			
			<div class="bottom-bot"> 
				<div id="left" class="left keyCo2 keyTap" style="margin-left: 20%; ">◀</div>
				
				<div id="bottom" class="bottom keyCo2 keyTap">▼</div>
				<div id="right" class="right keyCo2 keyTap">▶</div>
			</div>
			
		</div>
	</div> 
	<script type="text/javascript" src="js/jquery-1.8.3.min.js"></script>

	<script type="text/javascript">
	
	 	var home = $('#home');
	 	var main = $('#main');
	 	var snakeArr = [];
	 	var direction = "l";
	 	var rows = 32;
	 	var cols = 32;
	 	var timer = "";
	 	var food = [];
	 	var die = false;
	 	var score = 0;
	 	var snakeWidth = document.body.offsetWidth;
	 	var snakeHeight = window.screen.height ;
	 	
	 	home.css({"height":snakeWidth+"px","width":snakeWidth+"px"});
	 	main.css({"height":snakeWidth+"px","width":snakeWidth+"px"});
	 	
	 	//创造蛇 
	 	for (var i = 0; i <  4; i++) {
	 		var snakeDiv =$('<div class="snakeDiv" style="background:url(./images/snake'+ i +'.png) no-repeat; z-index:99;background-size:100% 100%;"></div>');

	 		home.append(snakeDiv);
	 		snakeArr[i] = {r : 14,c : 13 + i,div : snakeDiv,d : direction};
	 		setPostion(snakeArr[i]);
	 	}
	 	$('#res').click(function(){
	 		location.reload();
	 	})
	 	$('#start').click(function(){
	 		if (die) {
	 			alert('请点击重玩');
	 		};
	 		clearInterval(timer);
	 		move();
	 	})



	 	//蛇移动
	 	function move(){
	 		
	 		timer = setInterval(function(){
	 			for (var i = snakeArr.length-1; i > 0;i--) {
	 				snakeArr[i].r = snakeArr[i-1].r;
	 				snakeArr[i].c = snakeArr[i-1].c;
	 				snakeArr[i].d = snakeArr[i-1].d;
	 			}
	 			switch(direction){
	 				case "l" : snakeArr[0].c--;snakeArr[0].d = 'l';break;
	 				case "t" : snakeArr[0].r--;snakeArr[0].d = 't';break;
	 				case "r" : snakeArr[0].c++;snakeArr[0].d = 'r';break;
	 				case "b" : snakeArr[0].r++;snakeArr[0].d = 'b';break;
	 			}
	 			$(window).keydown(function(event){
	 				switch(event.keyCode){
	 					case 37 : direction = "l";break;
	 					case 38 : direction = "t";break;
	 					case 39 : direction = "r";break;
	 					case 40 : direction = "b";break;

	 				}

	 			})
						//手指接触屏幕
			    document.addEventListener("touchstart", function(e) {
			    	
			        startx = e.touches[0].pageX;
			        starty = e.touches[0].pageY;
			        // e.preventDefault();
			       
			    }, false);
			    //手指离开屏幕
			    document.addEventListener("touchend", function(e) {

			        var endx, endy;
			        endx = e.changedTouches[0].pageX;
			        endy = e.changedTouches[0].pageY;
			        console.log(startx);

			        var direction2 = getDirection(startx, starty, endx, endy);
			        switch (direction2) {
			            // case 0:
			            //     alert("未滑动！");
			            //     break;
			            case 1:
			               direction = "t";
			                break;
			            case 2:
			                direction = "b";
			                break;
			            case 3:
			               direction = "l";
			                break;
			            case 4:
			               direction = "r";
			                break;
			            default:
			        };
			        
			    }, false);
	 			for (var i = 0; i < snakeArr.length; i++) {
	 				setPostion(snakeArr[i]);
	 			}
	 			//蛇撞墙
	 			if (snakeArr[0].c < 0 || snakeArr[0].r < 0 || snakeArr[0].c >= cols || snakeArr[0].r >= rows) {
	 					clearInterval(timer);
	 				die = true;
	 				alert("请点击“重玩”");
	 			}
	 			//撞自己
	 			for (var i = 1; i < snakeArr.length; i++) {
	 				if (snakeArr[0].c == snakeArr[i].c && snakeArr[0].r == snakeArr[i].r) {
	 					
	 				
	 				clearInterval(timer);
	 				die = true;
	 				alert("GameOver");
	 				// $('#start').off("click")
	 				}
	 			}
	 			//蛇吃食物
	 			if(snakeArr[0].r == food[0].r && snakeArr[0].c == food[0].c){
	 				food[0].div.css({background : 'url("./images/snake2.png") 0% 0% / 100% 100% no-repeat'});
	 				// food[0].div.css({'background' :'url(./images/snake2.png) no-repeat;'});
	 				console.log(food[0])
	 				snakeArr.splice(snakeArr.length-1,0,food[0]);
	 				food.shift();
	 				score += 10;
	 				$('#score').html('<span>得分:</span>' + score)
	 	
	 				if (score >= 100){
	 					clearInterval(timer);
	 					//遍历数组
	 					for (var i = 0; i < snakeArr.length; i++) {
	 						
	 						$('#snakeOver').show();
                           
                          	
	 						$('#snakeOver').append(snakeArr[i].div);
	 						//把吃掉食物后的位置以及div传入给snakeArr数组
	 						snakeArr[i] = {r : 8,c : 0+i, div : snakeArr[i].div}
	 						
	 						restPostion(snakeArr[i]);

						
	 					};

	 				}
	 				// food[0].div.css({background:'url(images/snake2.png) no-repeat;background-size:100% 100%;'});
	 				// snakeArr.splice(snakeArr.length-1,0,food[0]);
	 				// food.shift();

	 			}
	 			if(food.length == 0){
	 				createFood();
	 			}
	 			
	 		},100)
	 	}
	 	//创造食物
	 	function createFood(){
	 		var r = parseInt(Math.random()*rows)
	 		var c = parseInt(Math.random()*cols)
	 		var crash = false;
	 		while(food.length == 0){
	 			for (var i = 0; i < snakeArr.length; i++) {
		 			if (c == snakeArr[i].c &&  r == snakeArr[i].r) {
		 				crash = true;
		 			}
	 			}
		 		if(!crash){
		 			var i = parseInt(4 * Math.random());
		 			var foodDiv = $('<div style="background:url(./images/coins' + i + '.png) no-repeat; z-index:999;background-size:100% 100%;" id="xx'+i+'"></div>')
		 			
		 			home.append(foodDiv);
		 			food.push({r : r, c : c, div : foodDiv})
		 			setPostion(food[0])
		 		}
	 		}
	 		
	 	}
		
	 	//设置初始位置
	 	function setPostion(obj){
	 		obj.div.css({left : obj.c * snakeWidth / 32,top : obj.r *snakeWidth / 32,width : snakeWidth / 32,height :  snakeWidth / 32});
	 		obj.div.removeClass().addClass(obj.d)
	 	}
	 		//设置蛇吃完的位置
	 	function restPostion(obj){
	 		obj.div.css({left : obj.c * snakeWidth / 32,top :0});
	 	}
	 	createFood();

	 	var startx, starty;
	    //获得角度
	    function getAngle(angx, angy) {
	        return Math.atan2(angy, angx) * 180 / Math.PI;
	    };
	 
	    //根据起点终点返回方向 1向上 2向下 3向左 4向右 0未滑动
	    function getDirection(startx, starty, endx, endy) {
	        var angx = endx - startx;
	        var angy = endy - starty;
	        var result = 0;
	 
	        //如果滑动距离太短
	        if (Math.abs(angx) < 2 && Math.abs(angy) < 2) {
	            return result;
	        }
	 
	        var angle = getAngle(angx, angy);
	        if (angle >= -135 && angle <= -45) {
	            result = 1;
	        } else if (angle > 45 && angle < 135) {
	            result = 2;
	        } else if ((angle >= 135 && angle <= 180) || (angle >= -180 && angle < -135)) {
	            result = 3;
	        } else if (angle >= -45 && angle <= 45) {
	            result = 4;
	        }
	 
	        return result;
	    }
	    //手指接触屏幕
	    $('#top').on('click',function(){
	    	direction = "t";
	    })
	    $('#left').on('click',function(){
	    	direction = "l";
	    })
	    $('#right').on('click',function(){
	    	direction = "r";
	    })                         
	    $('#bottom').on('click',function(){
	    	direction = "b";
	    })
	</script>
</body>
</html>